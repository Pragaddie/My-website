<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Live Location ‚Äî Classic Blue Dot + Name</title>

  <!-- MapLibre -->
  <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet"/>
  <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>

  <!-- Firebase (compat for one-file simplicity) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore-compat.js"></script>

  <style>
    :root { --bg:#0b0f16; --card:#101827; --muted:#9aa3b2; --text:#e6e8ee; --accent:#2F80ED; }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font:14px system-ui,-apple-system,Segoe UI,Roboto,Arial}
    #app{height:100%;display:flex;flex-direction:column}
    header{
      height:56px;display:flex;align-items:center;gap:8px;padding:8px 12px;border-bottom:1px solid #121a2a;
      background:linear-gradient(180deg,rgba(8,11,18,.95),rgba(8,11,18,.6));backdrop-filter:blur(6px);z-index:10
    }
    header .brand{font-weight:700}
    header .spacer{flex:1}
    .btn{background:#0f172a;border:1px solid #1f2937;color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .pill{background:#0f172a;border:1px solid #1f2937;color:#9aa3af;padding:6px 10px;border-radius:999px}
    #map{flex:1;min-height:0}
    .panel{
      position:fixed;inset:auto 12px 12px auto;width:320px;max-width:calc(100% - 24px);
      background:var(--card);border:1px solid #1a2335;border-radius:16px;padding:12px;z-index:20
    }
    .field{width:100%;padding:10px;border-radius:10px;border:1px solid #243045;background:#0f172a;color:var(--text)}
    .row{display:flex;gap:8px;align-items:center}
    .col{display:flex;flex-direction:column;gap:8px}
    .center{display:flex;align-items:center;justify-content:center;height:100%}
    .card{width:min(420px,92%);background:var(--card);border:1px solid #1a2335;border-radius:16px;padding:16px}
    .link{color:#93c5fd;cursor:pointer}
    .toast{
      position:fixed;bottom:16px;left:50%;transform:translateX(-50%);
      background:#0f172a;border:1px solid #1f2937;color:var(--text);padding:8px 12px;border-radius:10px;z-index:999
    }
    .warn{background:#7c2d12;border-color:#9a3412}
  </style>
</head>
<body>
<div id="app">

  <header>
    <div class="brand">LiveMap</div>
    <div class="spacer"></div>
    <div id="authedControls" style="display:none; gap:8px" class="row">
      <button id="goLiveBtn"  class="btn" type="button">‚ñ∂ Go live</button>
      <button id="stopLiveBtn" class="btn" type="button" disabled>‚èπ Stop</button>
      <button id="followBtn"   class="btn" type="button">üéØ Follow: ON</button>
      <button id="logoutBtn"   class="btn" type="button">üö™ Log out</button>
      <span id="status" class="pill">Signed in</span>
    </div>
  </header>

  <!-- AUTH SCREENS -->
  <div id="authScreens" class="center">
    <!-- LOGIN -->
    <div id="loginCard" class="card">
      <h3 style="margin:0 0 8px">Log in</h3>
      <div class="col">
        <input id="loginEmail" class="field" type="email" placeholder="Email"/>
        <input id="loginPass"  class="field" type="password" placeholder="Password"/>
        <button id="loginBtn"  class="btn" type="button">Log in</button>
        <div style="color:var(--muted)">No account? <span id="toSignup" class="link">Create one</span></div>
        <div id="loginErr" style="color:#fca5a5"></div>
      </div>
    </div>
    <!-- SIGNUP -->
    <div id="signupCard" class="card" style="display:none">
      <h3 style="margin:0 0 8px">Create account</h3>
      <div class="col">
        <input id="suName"  class="field" placeholder="Display name (shown above your dot)"/>
        <input id="suEmail" class="field" type="email" placeholder="Email"/>
        <input id="suPass"  class="field" type="password" placeholder="Password (min 6 chars)"/>
        <button id="signupBtn" class="btn" type="button">Sign up</button>
        <div style="color:var(--muted)">Have an account? <span id="toLogin" class="link">Log in</span></div>
        <div id="signupErr" style="color:#fca5a5"></div>
      </div>
    </div>
  </div>

  <!-- MAP -->
  <div id="map" style="display:none"></div>

  <!-- Legend -->
  <div id="legend" class="panel" style="display:none">
    <div class="col">
      <div><b>How it works</b></div>
      <div class="row"><span class="pill">1</span> Log in / Create account</div>
      <div class="row"><span class="pill">2</span> Click <b>Go live</b> (allow location)</div>
      <div class="row"><span class="pill">3</span> See all other live users as <b>blue dots</b> with their display names</div>
      <div class="row"><span class="pill">4</span> Stop / Log out / close tab ‚Üí you disappear</div>
    </div>
  </div>

</div>

<script>
  // ---------- secure context hint ----------
  const SECURE_OK = location.protocol === 'https:' || location.hostname === 'localhost';
  function toast(msg, warn=false){ const t=document.createElement('div'); t.className='toast'+(warn?' warn':''); t.textContent=msg; document.body.appendChild(t); setTimeout(()=>t.remove(), 2600); }
  if (!SECURE_OK) toast('Use HTTPS or http://localhost ‚Äî precise GPS needs a secure context.', true);

  // ---------- Firebase (your project: maps-46c58) ----------
  const firebaseConfig = {
    apiKey: "AIzaSyClWN488bGSNubdX5V63u4j_HRT8jUdif4",
    authDomain: "maps-46c58.firebaseapp.com",
    projectId: "maps-46c58",
    storageBucket: "maps-46c58.firebasestorage.app",
    messagingSenderId: "334648884277",
    appId: "1:334648884277:web:acbcc1a3c82b12e7e9c57c",
    measurementId: "G-WVW7W93TB2"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db   = firebase.firestore();

  // ---------- DOM refs ----------
  const $ = (id)=>document.getElementById(id);
  const authScreens=$('authScreens'), loginCard=$('loginCard'), signupCard=$('signupCard');
  const mapDiv=$('map'), legend=$('legend'), authedCtrls=$('authedControls');
  const loginEmail=$('loginEmail'), loginPass=$('loginPass'), loginBtn=$('loginBtn'), loginErr=$('loginErr');
  const suName=$('suName'), suEmail=$('suEmail'), suPass=$('suPass'), signupBtn=$('signupBtn'), signupErr=$('signupErr');
  const toSignup=$('toSignup'), toLogin=$('toLogin');
  const goLiveBtn=$('goLiveBtn'), stopLiveBtn=$('stopLiveBtn'), followBtn=$('followBtn'), logoutBtn=$('logoutBtn'), statusEl=$('status');

  // attach handlers ASAP
  window.addEventListener('DOMContentLoaded', () => {
    toSignup.addEventListener('click', ()=>{ loginCard.style.display='none'; signupCard.style.display='block'; });
    toLogin .addEventListener('click', ()=>{ signupCard.style.display='none'; loginCard.style.display='block'; });
    loginBtn.addEventListener('click', onLogin);
    signupBtn.addEventListener('click', onSignup);
    logoutBtn.addEventListener('click', async ()=>{ await stopLive(); await auth.signOut(); });
    goLiveBtn.addEventListener('click', startLive);
    stopLiveBtn.addEventListener('click', stopLive);
    followBtn.addEventListener('click', ()=>{
      my.follow = !my.follow;
      followBtn.textContent = `üéØ Follow: ${my.follow ? 'ON' : 'OFF'}`;
      if (my.follow && my.lastLL) map?.easeTo({ center: my.lastLL, duration: 500 });
    });
  });

  // ---------- Auth handlers ----------
  async function onLogin(){
    loginErr.textContent=''; loginBtn.disabled=true;
    try{
      const email=loginEmail.value.trim(), pass=loginPass.value;
      if(!email||!pass) throw new Error('Enter email and password.');
      await auth.signInWithEmailAndPassword(email, pass);
    }catch(e){ loginErr.textContent = e.message || String(e); toast(loginErr.textContent, true); }
    finally{ loginBtn.disabled=false; }
  }
  async function onSignup(){
    signupErr.textContent=''; signupBtn.disabled=true;
    try{
      const name=suName.value.trim(), email=suEmail.value.trim(), pass=suPass.value;
      if(!name) throw new Error('Please enter a display name.');
      if(!email||!pass) throw new Error('Enter email and password.');
      const cred = await auth.createUserWithEmailAndPassword(email, pass);
      await cred.user.updateProfile({ displayName: name });
      await db.collection('users').doc(cred.user.uid).set({ name }, { merge:true });
      signupCard.style.display='none'; loginCard.style.display='block';
      toast('Account created. Please log in.');
    }catch(e){ signupErr.textContent = e.message || String(e); toast(signupErr.textContent, true); }
    finally{ signupBtn.disabled=false; }
  }

  // ---------- Map setup ----------
  let map, mapLoaded=false;
  function setupMapOnce(){
    if (map) return;
    if (!window.maplibregl){ toast('Map library failed to load. Check network/CSP.', true); return; }
    map = new maplibregl.Map({
      container: "map",
      style: {
        "version": 8,
        "glyphs": "https://demotiles.maplibre.org/font/{fontstack}/{range}.pbf",  // required for text labels
        "sources": {
          "osm": { "type":"raster", "tiles":["https://tile.openstreetmap.org/{z}/{x}/{y}.png"], "tileSize":256, "attribution":"¬© OpenStreetMap contributors" }
        },
        "layers": [{ "id":"osm", "type":"raster", "source":"osm" }]
      },
      center: [-79.3832, 43.6532],
      zoom: 15
    });
    map.addControl(new maplibregl.NavigationControl(), "top-right");
    map.on('load', () => { mapLoaded=true; ensurePeopleLayers(); renderPeople(); });
  }

  // Build/ensure the layers every time before drawing
  function ensurePeopleLayers(){
    if (!map) return;
    // GeoJSON source
    if (!map.getSource('people')){
      map.addSource('people', { type:'geojson', data:{ type:'FeatureCollection', features:[] }});
    }
    // Soft halo (classic circle under the dot) ‚Äî fixed pixel radius
    if (!map.getLayer('people-halo')){
      map.addLayer({
        id:'people-halo', type:'circle', source:'people',
        filter:['==',['get','kind'],'point'],
        paint:{
          'circle-radius': 16,
          'circle-color': '#2F80ED',
          'circle-opacity': 0.18
        }
      });
    }
    // Blue dot
    if (!map.getLayer('people-dots')){
      map.addLayer({
        id:'people-dots', type:'circle', source:'people',
        filter:['==',['get','kind'],'point'],
        paint:{
          'circle-radius': 8,
          'circle-color': '#2F80ED',
          'circle-stroke-color': '#ffffff',
          'circle-stroke-width': 2
        }
      });
    }
    // Name label (fonts exist on this glyph server)
    if (!map.getLayer('people-labels')){
      map.addLayer({
        id:'people-labels', type:'symbol', source:'people',
        filter:['==',['get','kind'],'point'],
        layout:{
          'text-field':['get','name'],
          'text-font':['Open Sans Regular','Arial Unicode MS Regular'],
          'text-size': 12,
          'text-offset':[0,1.4],
          'text-anchor':'top',
          'text-allow-overlap': true,
          'text-ignore-placement': true
        },
        paint:{
          'text-color':'#e6e8ee',
          'text-halo-color':'#0b0f16',
          'text-halo-width':1.2
        }
      });
    }
  }

  // ---------- People rendering ----------
  const users = new Map(); // uid -> {lng,lat,name,ts}
  function renderPeople(){
    if (!mapLoaded) return;
    ensurePeopleLayers();
    const src = map.getSource('people'); if (!src) return;
    const now=Date.now(), feats=[];
    let liveCount=0;
    users.forEach((u,uid)=>{
      if (now-u.ts>30000) return;
      liveCount++;
      feats.push({ type:'Feature', properties:{uid,kind:'point',name:u.name||''}, geometry:{ type:'Point', coordinates:[u.lng,u.lat] }});
    });
    src.setData({ type:'FeatureCollection', features:feats });
    statusEl.textContent = `${my.live ? 'Live' : 'Signed in'} ‚Ä¢ showing ${liveCount} user(s)`;
  }

  // ---------- Auth state / profile ----------
  let my = { uid:null, name:'', live:false, watchId:null, follow:true, lastLL:null };
  let presenceUnsub = null;

  function deriveName(user, doc){
    if (user?.displayName) return user.displayName;           // preferred
    if (doc?.exists && doc.data()?.name) return doc.data().name;
    if (user?.email) return user.email.split('@')[0];         // fallback
    return 'Me';
  }

  auth.onAuthStateChanged(async (user)=>{
    if (user){
      const prof = await db.collection('users').doc(user.uid).get();
      my.uid = user.uid;
      my.name = deriveName(user, prof);
      await db.collection('users').doc(user.uid).set({ name: my.name }, { merge:true });

      authScreens.style.display='none';
      mapDiv.style.display='block';
      legend.style.display='block';
      authedCtrls.style.display='flex';
      statusEl.textContent='Signed in';

      setupMapOnce();
    } else {
      await stopLive();
      users.clear(); renderPeople();
      authedCtrls.style.display='none';
      mapDiv.style.display='none';
      legend.style.display='none';
      authScreens.style.display='flex';
      signupCard.style.display='none';
      loginCard.style.display='block';
    }
  });

  // ---------- Presence (others) ----------
  function startPresenceListener(){
    if (presenceUnsub) return;
    presenceUnsub = db.collection('presence').onSnapshot((snap)=>{
      const now = Date.now();
      snap.docChanges().forEach(ch=>{
        const uid=ch.doc.id, d=ch.doc.data();
        if (!d || typeof d.lat!=='number' || typeof d.lng!=='number') { users.delete(uid); return; }
        const ts = d.updatedAt?.toMillis?.() ? d.updatedAt.toMillis() : now;
        if (ch.type==='removed') users.delete(uid);
        else users.set(uid, { lng:d.lng, lat:d.lat, name:d.name||'', ts });
      });
      renderPeople();
    });
  }
  function stopPresenceListener(){ if (presenceUnsub){ presenceUnsub(); presenceUnsub=null; } }

  // ---------- Live location ----------
  const GEO_OPTS_FIRST = { enableHighAccuracy:true, timeout:20000, maximumAge:0 };
  const GEO_OPTS_WATCH = { enableHighAccuracy:true, timeout:15000, maximumAge:0 };

  async function startLive(){
    if (!auth.currentUser) return;
    if (!SECURE_OK) toast('Use HTTPS or http://localhost for precise GPS.', true);
    if (my.watchId != null) return;

    startPresenceListener(); // only while I'm live

    // Precision first fix
    navigator.geolocation.getCurrentPosition((pos)=>onPos(pos,true), ()=>{}, GEO_OPTS_FIRST);
    // Continuous updates
    my.watchId = navigator.geolocation.watchPosition(onPos, onErr, GEO_OPTS_WATCH);

    goLiveBtn.disabled=true; stopLiveBtn.disabled=false;
    statusEl.textContent='Live (sharing)‚Ä¶';
    my.live=true;
  }

  async function stopLive(){
    if (my.watchId != null){ navigator.geolocation.clearWatch(my.watchId); my.watchId=null; }
    if (my.uid){ try{ await db.collection('presence').doc(my.uid).delete(); }catch(e){} }
    stopPresenceListener();
    users.delete(my.uid); renderPeople();
    goLiveBtn.disabled=false; stopLiveBtn.disabled=true;
    statusEl.textContent = auth.currentUser ? 'Signed in' : 'Signed out';
    my.live=false;
  }

  window.addEventListener('beforeunload', ()=>{ if (my.live && my.uid) db.collection('presence').doc(my.uid).delete(); });

  let writeTimer=null;
  function onPos(pos, first=false){
    const { latitude, longitude } = pos.coords;
    my.lastLL=[longitude, latitude];

    const display = (my.name && my.name.trim()) ? my.name : (auth.currentUser?.email ? auth.currentUser.email.split('@')[0] : 'Me');

    // Update local immediately (so dot + name show even before Firestore round-trip)
    users.set(my.uid, { lng:longitude, lat:latitude, name:display, ts:Date.now() });
    renderPeople();

    if (my.follow || first) map?.easeTo({ center:[longitude, latitude], duration: first?0:400 });

    // Share to Firestore (so others see me)
    clearTimeout(writeTimer);
    writeTimer = setTimeout(()=> {
      db.collection('presence').doc(my.uid).set({
        lat: latitude, lng: longitude, name: display,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge:true });
    }, 300);
  }

  function onErr(err){
    statusEl.textContent = err.message || 'Location error';
    if (err.code === 1) toast('Allow location permissions.', true);
  }
</script>
</body>
</html>
