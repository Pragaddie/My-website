<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Live Location ‚Äî Blue Dots with Names</title>

  <!-- MapLibre -->
  <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet"/>
  <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>

  <!-- Firebase (compat for simple single-file) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore-compat.js"></script>

  <style>
    :root { --bg:#0b0f16; --card:#101827; --muted:#9aa3b2; --text:#e6e8ee; --accent:#2F80ED; }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font:14px system-ui,-apple-system,Segoe UI,Roboto,Arial}
    #app{height:100%;display:flex;flex-direction:column}
    header{
      height:56px;display:flex;align-items:center;gap:8px;padding:8px 12px;border-bottom:1px solid #121a2a;
      background:linear-gradient(180deg,rgba(8,11,18,.95),rgba(8,11,18,.6));backdrop-filter:blur(6px);z-index:10
    }
    header .brand{font-weight:700}
    header .spacer{flex:1}
    .btn{
      background:#0f172a;border:1px solid #1f2937;color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer
    }
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .pill{background:#0f172a;border:1px solid #1f2937;color:#9aa3af;padding:6px 10px;border-radius:999px}
    #map{flex:1;min-height:0}
    .panel{
      position:fixed;inset:auto 12px 12px auto;width:320px;max-width:calc(100% - 24px);
      background:var(--card);border:1px solid #1a2335;border-radius:16px;padding:12px;z-index:20
    }
    .field{width:100%;padding:10px;border-radius:10px;border:1px solid #243045;background:#0f172a;color:var(--text)}
    .row{display:flex;gap:8px;align-items:center}
    .col{display:flex;flex-direction:column;gap:8px}
    .center{display:flex;align-items:center;justify-content:center;height:100%}
    .card{
      width:min(420px,92%);background:var(--card);border:1px solid #1a2335;border-radius:16px;padding:16px
    }
    .link{color:#93c5fd;cursor:pointer}
    .toast{position:fixed;bottom:16px;left:50%;transform:translateX(-50%);background:#0f172a;border:1px solid #1f2937;color:var(--text);padding:8px 12px;border-radius:10px;z-index:999}
  </style>
</head>
<body>
<div id="app">

  <header>
    <div class="brand">LiveMap</div>
    <div class="spacer"></div>
    <div id="authedControls" style="display:none; gap:8px" class="row">
      <button id="goLiveBtn" class="btn">‚ñ∂ Go live</button>
      <button id="stopLiveBtn" class="btn" disabled>‚èπ Stop</button>
      <button id="followBtn" class="btn">üéØ Follow: ON</button>
      <button id="logoutBtn" class="btn">üö™ Log out</button>
      <span id="status" class="pill">Signed in</span>
    </div>
  </header>

  <!-- AUTH SCREENS -->
  <div id="authScreens" class="center">
    <!-- LOGIN -->
    <div id="loginCard" class="card">
      <h3 style="margin:0 0 8px">Log in</h3>
      <div class="col">
        <input id="loginEmail" class="field" type="email" placeholder="Email"/>
        <input id="loginPass" class="field" type="password" placeholder="Password"/>
        <button id="loginBtn" class="btn">Log in</button>
        <div style="color:var(--muted)">No account? <span id="toSignup" class="link">Create one</span></div>
        <div id="loginErr" style="color:#fca5a5"></div>
      </div>
    </div>
    <!-- SIGNUP -->
    <div id="signupCard" class="card" style="display:none">
      <h3 style="margin:0 0 8px">Create account</h3>
      <div class="col">
        <input id="suName"  class="field" placeholder="Display name (shown above your dot)"/>
        <input id="suEmail" class="field" type="email" placeholder="Email"/>
        <input id="suPass"  class="field" type="password" placeholder="Password (min 6 chars)"/>
        <button id="signupBtn" class="btn">Sign up</button>
        <div style="color:var(--muted)">Have an account? <span id="toLogin" class="link">Log in</span></div>
        <div id="signupErr" style="color:#fca5a5"></div>
      </div>
    </div>
  </div>

  <!-- MAP -->
  <div id="map" style="display:none"></div>

  <!-- Small legend / how-to -->
  <div id="legend" class="panel" style="display:none">
    <div class="col">
      <div><b>How it works</b></div>
      <div class="row"><span class="pill">1</span> Log in / Create account</div>
      <div class="row"><span class="pill">2</span> Click <b>Go live</b> (allow location)</div>
      <div class="row"><span class="pill">3</span> See all other live users as <b>blue dots</b> with their display names</div>
      <div class="row"><span class="pill">4</span> <b>Stop</b> / Log out / close tab ‚Üí you disappear instantly</div>
    </div>
  </div>

</div>

<script>
  // ---------------- Firebase ----------------
  // 1) Create a Firebase project
  // 2) Enable Authentication (Email/Password)
  // 3) Enable Firestore (Native mode)
  // 4) Paste your config below:
  const firebaseConfig = {
  apiKey: "AIzaSyClWN488bGSNubdX5V63u4j_HRT8jUdif4",
  authDomain: "maps-46c58.firebaseapp.com",
  projectId: "maps-46c58",
  storageBucket: "maps-46c58.firebasestorage.app",
  messagingSenderId: "334648884277",
  appId: "1:334648884277:web:acbcc1a3c82b12e7e9c57c",
  measurementId: "G-WVW7W93TB2"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db   = firebase.firestore();

  // ---------------- UI helpers ----------------
  const $ = (id)=>document.getElementById(id);
  function toast(msg){ const t=document.createElement('div'); t.className='toast'; t.textContent=msg; document.body.appendChild(t); setTimeout(()=>t.remove(),1800); }

  // Screens
  const authScreens  = $('authScreens');
  const loginCard    = $('loginCard');
  const signupCard   = $('signupCard');
  const mapDiv       = $('map');
  const legend       = $('legend');
  const authedCtrls  = $('authedControls');

  // Auth inputs
  const loginEmail = $('loginEmail'), loginPass = $('loginPass'), loginBtn = $('loginBtn'), loginErr = $('loginErr');
  const suName = $('suName'), suEmail = $('suEmail'), suPass = $('suPass'), signupBtn = $('signupBtn'), signupErr = $('signupErr');
  $('toSignup').onclick = ()=>{ loginCard.style.display='none'; signupCard.style.display='block'; };
  $('toLogin').onclick  = ()=>{ signupCard.style.display='none'; loginCard.style.display='block'; };

  // Authed controls
  const goLiveBtn = $('goLiveBtn'), stopLiveBtn = $('stopLiveBtn'), followBtn = $('followBtn'), logoutBtn = $('logoutBtn'), statusEl = $('status');

  // ---------------- MapLibre setup ----------------
  const map = new maplibregl.Map({
    container: "map",
    style: {
      "version": 8,
      "sources": {
        "osm": {
          "type": "raster",
          "tiles": ["https://tile.openstreetmap.org/{z}/{x}/{y}.png"],
          "tileSize": 256,
          "attribution": "¬© OpenStreetMap contributors"
        }
      },
      "layers": [
        { "id": "osm", "type": "raster", "source": "osm" }
      ]
    },
    center: [-79.3832, 43.6532], // Toronto default
    zoom: 15
  });
  map.addControl(new maplibregl.NavigationControl(), "top-right");

  // Source to hold all people (including me)
  map.on('load', () => {
    map.addSource('people', { type: 'geojson', data: { type: 'FeatureCollection', features: [] } });

    // Blue dot
    map.addLayer({
      id: 'people-dots',
      type: 'circle',
      source: 'people',
      paint: {
        'circle-radius': 8,
        'circle-color': '#2F80ED',
        'circle-stroke-color': '#ffffff',
        'circle-stroke-width': 2
      }
    });

    // Name labels (always shown above the dot)
    map.addLayer({
      id: 'people-labels',
      type: 'symbol',
      source: 'people',
      layout: {
        'text-field': ['get', 'name'],
        'text-font': ['Open Sans Semibold','Arial Unicode MS Regular'],
        'text-size': 12,
        'text-offset': [0, 1.4],        // lift above the dot
        'text-anchor': 'top',
        'text-allow-overlap': true,
        'text-ignore-placement': true
      },
      paint: {
        'text-color': '#e6e8ee',
        'text-halo-color': '#0b0f16',
        'text-halo-width': 1.2
      }
    });
  });

  // Keep features in memory for fast updates
  const featuresByUid = new Map();
  function renderPeople(){
    const fc = { type:'FeatureCollection', features:[...featuresByUid.values()] };
    const src = map.getSource('people');
    if (src) src.setData(fc);
  }

  // ---------------- Auth flows ----------------
  let my = { uid:null, name:'', live:false, watchId:null, follow:true };
  let presenceUnsub = null;

  auth.onAuthStateChanged(async (user)=>{
    if (user){
      my.uid = user.uid;
      // Fetch profile name (prefer Auth displayName, else Firestore users doc)
      my.name = user.displayName || '';
      if (!my.name){
        const doc = await db.collection('users').doc(my.uid).get();
        my.name = (doc.exists && doc.data().name) ? doc.data().name : '';
      }
      // Show app UI
      authScreens.style.display = 'none';
      mapDiv.style.display = 'block';
      legend.style.display = 'block';
      authedCtrls.style.display = 'flex';
      statusEl.textContent = 'Signed in';
      // Center once someone goes live
    } else {
      // Clean UI + state
      stopLive(); // ensure we stop tracking and delete presence
      featuresByUid.clear(); renderPeople();
      authedCtrls.style.display = 'none';
      mapDiv.style.display = 'none';
      legend.style.display = 'none';
      authScreens.style.display = 'flex';
      signupCard.style.display = 'none';
      loginCard.style.display = 'block';
    }
  });

  loginBtn.onclick = async ()=>{
    loginErr.textContent = '';
    try{
      const cred = await auth.signInWithEmailAndPassword(loginEmail.value.trim(), loginPass.value);
      toast('Logged in');
    }catch(e){ loginErr.textContent = e.message; }
  };

  signupBtn.onclick = async ()=>{
    signupErr.textContent = '';
    const name = suName.value.trim();
    if (!name){ signupErr.textContent = 'Please enter display name.'; return; }
    try{
      const cred = await auth.createUserWithEmailAndPassword(suEmail.value.trim(), suPass.value);
      await cred.user.updateProfile({ displayName: name });
      await db.collection('users').doc(cred.user.uid).set({ name }, { merge:true });
      toast('Account created. You can go live!');
      // Switch to map view automatically (auth listener will handle)
    }catch(e){ signupErr.textContent = e.message; }
  };

  logoutBtn.onclick = async ()=>{
    await stopLive();
    await auth.signOut();
  };

  // ---------------- Live location (only live users can see others) ----------------
  goLiveBtn.onclick = ()=> startLive();
  stopLiveBtn.onclick = ()=> stopLive();
  followBtn.onclick = ()=>{
    my.follow = !my.follow;
    followBtn.textContent = `üéØ Follow: ${my.follow ? 'ON' : 'OFF'}`;
    if (my.follow && featuresByUid.has(my.uid)){
      const f = featuresByUid.get(my.uid);
      map.easeTo({ center: f.geometry.coordinates, duration: 500 });
    }
  };

  function startPresenceListener(){
    // Only listen while I'm live (enforces "only live users see others")
    if (presenceUnsub) return;
    presenceUnsub = db.collection('presence').onSnapshot((snap)=>{
      const now = Date.now();
      snap.docChanges().forEach(ch=>{
        const uid = ch.doc.id; const d = ch.doc.data();
        if (!d || !d.lat || !d.lng) return;
        // Hide stale (> 30s old)
        const ts = d.updatedAt?.toMillis?.() ? d.updatedAt.toMillis() : now;
        if (now - ts > 30000) return;

        if (ch.type === 'removed'){
          featuresByUid.delete(uid);
        }else{
          featuresByUid.set(uid, {
            type:'Feature',
            properties:{ uid, name: d.name || '' },
            geometry:{ type:'Point', coordinates:[d.lng, d.lat] }
          });
        }
      });
      renderPeople();
    });
  }

  function stopPresenceListener(){
    if (presenceUnsub){ presenceUnsub(); presenceUnsub = null; }
  }

  function startLive(){
    if (!auth.currentUser){ toast('Log in first'); return; }
    if (my.watchId != null) return;

    // Start listening to others (only when I'm live)
    startPresenceListener();

    // Start GPS stream
    my.watchId = navigator.geolocation.watchPosition(onPos, onErr, {
      enableHighAccuracy:true, maximumAge:0, timeout:15000
    });

    goLiveBtn.disabled = true; stopLiveBtn.disabled = false;
    statusEl.textContent = 'Live (sharing location)‚Ä¶';
    my.live = true;
  }

  async function stopLive(){
    // Stop GPS
    if (my.watchId != null){ navigator.geolocation.clearWatch(my.watchId); my.watchId = null; }
    // Remove my presence doc
    if (my.uid){
      try{ await db.collection('presence').doc(my.uid).delete(); }catch(e){}
    }
    // Stop listening to others
    stopPresenceListener();
    // Remove my local feature
    featuresByUid.delete(my.uid); renderPeople();

    goLiveBtn.disabled = false; stopLiveBtn.disabled = true;
    statusEl.textContent = 'Signed in';
    my.live = false;
  }

  // Try to clean up if the tab closes
  window.addEventListener('beforeunload', ()=>{ if (my.live) db.collection('presence').doc(my.uid).delete(); });

  let writeTimer=null;
  function onPos(pos){
    const { latitude, longitude, accuracy } = pos.coords;

    // Update my local feature immediately
    featuresByUid.set(my.uid, {
      type:'Feature',
      properties:{ uid: my.uid, name: my.name || 'Me' },
      geometry:{ type:'Point', coordinates:[longitude, latitude] }
    });
    renderPeople();

    if (my.follow) map.easeTo({ center:[longitude, latitude], duration: 500 });

    statusEl.textContent = `Live ‚Ä¢ ¬±${Math.round(accuracy||0)} m`;
    // Throttle Firestore writes
    clearTimeout(writeTimer);
    writeTimer = setTimeout(()=> {
      db.collection('presence').doc(my.uid).set({
        lat: latitude, lng: longitude, acc: accuracy||0,
        name: my.name || '',
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge:true });
    }, 350);
  }
  function onErr(err){
    statusEl.textContent = err.message || 'Location error';
    if (err.code === 1) toast('Allow location permissions.');
  }
</script>
</body>
</html>
