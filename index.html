<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Live Map ‚Äî Pokes + Status</title>
  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <style>
    :root {
      --bg: #0e0f12;
      --panel: #15171c;
      --border: #272a33;
      --text: #e9ecf1;
      --muted: #9aa3af;
      --accent: #4f46e5;
      --good: #22c55e;
      --danger: #ef4444;
      --yellow: #f59e0b;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; color: var(--text); background: var(--bg);
      font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif;
    }
    #app { display: grid; grid-template-rows: auto 1fr; height: 100%; }

    header {
      display: grid; grid-template-columns: 1fr auto; gap: 12px; align-items: center;
      padding: 10px 12px; background: var(--panel); border-bottom: 1px solid var(--border);
      position: relative; z-index: 10;
    }
    .brand { font-weight: 700; letter-spacing: 0.2px; }
    .controls { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
    .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }

    input[type="email"], input[type="password"], input[type="text"] {
      background: #0f1116; color: var(--text); border: 1px solid var(--border);
      padding: 8px 10px; border-radius: 10px; outline: none; min-width: 180px;
    }
    input.small { min-width: 140px; }

    .btn {
      background: #1a1e27; color: var(--text); border: 1px solid var(--border);
      padding: 8px 12px; border-radius: 10px; cursor: pointer; transition: .15s ease;
    }
    .btn:hover { border-color: #3a3f4d; }
    .btn.primary { background: var(--accent); border-color: #463fd4; }
    .btn.good { background: var(--good); border-color: #16a34a; color: #03150a; font-weight: 600; }
    .btn.danger { background: #2b1212; border-color: #7f1d1d; color: #fecaca; }

    #map { width: 100%; height: 100%; }

    /* Toast */
    .toast {
      position: fixed; bottom: 16px; left: 50%; transform: translateX(-50%) translateY(20px);
      background: rgba(25,27,33,0.95); color: var(--text); border: 1px solid var(--border);
      padding: 10px 14px; border-radius: 12px; box-shadow: 0 10px 28px rgba(0,0,0,0.3);
      opacity: 0; pointer-events: none; transition: opacity .18s ease, transform .18s ease; z-index: 9999;
      max-width: 92vw;
    }

    /* Floating status banner */
    #statusBanner {
      position: fixed; top: 12px; left: 50%; transform: translateX(-50%) translateY(-20px);
      background: rgba(25,25,28,0.92); color: #fff; padding: 10px 14px; border-radius: 12px;
      font: 500 14px/1.25 system-ui, sans-serif; box-shadow: 0 6px 20px rgba(0,0,0,0.25);
      opacity: 0; pointer-events: none; transition: opacity .18s ease, transform .18s ease; z-index: 9999;
      max-width: 92vw;
    }

    /* Marker label */
    .dot-label {
      display: inline-flex; align-items: center; gap: 6px; padding: 4px 8px; border-radius: 999px;
      background: rgba(14,15,18,0.85); color: #fff; border: 1px solid rgba(255,255,255,0.09);
      backdrop-filter: blur(4px);
      box-shadow: 0 4px 14px rgba(0,0,0,0.35);
      white-space: nowrap; font-weight: 600; font-size: 12px;
    }
    .dot-circle { width: 10px; height: 10px; border-radius: 50%; background: #3b82f6; box-shadow: 0 0 0 2px rgba(59,130,246,0.35); }
    .me .dot-circle { background: #22c55e; box-shadow: 0 0 0 2px rgba(34,197,94,0.35); }

    .muted { color: var(--muted); font-size: 12px; }
    .sep { width: 1px; height: 20px; background: var(--border); margin: 0 6px; }

    /* Compact on small screens */
    @media (max-width: 960px) {
      input[type="email"], input[type="password"], input[type="text"] { min-width: 140px; }
      header { grid-template-columns: 1fr; }
    }    /* Leaflet popup styling for status */
    .status-pop .leaflet-popup-content-wrapper { background: rgba(25,25,28,0.95); color:#fff; border-radius:12px; border:1px solid rgba(255,255,255,0.08); box-shadow:0 10px 28px rgba(0,0,0,0.35); }
    .status-pop .leaflet-popup-tip { background: rgba(25,25,28,0.95); }
    .status-pop .leaflet-popup-content { margin:10px 12px; font-weight:500; font-size:13px; }
    .status-pop .muted { color:#cbd5e1; opacity:.8; }
  </style>
</head>
<body>
<div id="app">
  <header>
    <div class="brand">üìç Live Map ‚Äî Pokes + Status</div>
    <div class="controls">
      <div class="row" id="authRow">
        <input id="email" class="small" type="email" placeholder="Email" autocomplete="username" />
        <input id="password" class="small" type="password" placeholder="Password" autocomplete="current-password" />
        <button id="signupBtn" class="btn">Create account</button>
        <button id="loginBtn" class="btn primary">Log in</button>
        <button id="logoutBtn" class="btn danger" style="display:none">Log out</button>
        <span id="whoami" class="muted" style="display:none"></span>
      </div>

      <span class="sep"></span>

      <div class="row" id="profileRow" style="display:none">
        <input id="displayName" type="text" placeholder="Display name" class="small" />
        <button id="saveNameBtn" class="btn">Save name</button>
        <input id="statusInput" type="text" maxlength="120" placeholder="What are you doing? (status)" class="small" style="min-width:220px" />
        <button id="saveStatusBtn" class="btn">Save status</button>
      </div>

      <span class="sep"></span>

      <div class="row">
        <button id="goLiveBtn" class="btn good">Go live</button>
        <button id="stopBtn" class="btn" style="display:none">Stop</button>
        <span class="muted" id="hintHttps"></span>
      </div>
    </div>
  </header>

  <div id="map"></div>
</div>

<div id="toast" class="toast"></div>
<div id="statusBanner"></div>

<!-- Firebase (v10 modular) -->
<script type="module">
  // Catch top-level errors and surface them to the user
  window.addEventListener('error', (e) => {
    console.error('Runtime error:', e.error || e.message);
    const t = document.getElementById('toast');
    if (t) { t.textContent = 'Error: ' + (e.error?.message || e.message); t.style.opacity = '1'; }
  });

  // ======== Firebase init ========
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import {
    getFirestore, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc,
    collection, onSnapshot, query, where, orderBy, limit, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  // == Use your project config (maps-46c58) ==
  const firebaseConfig = {
    apiKey: "AIzaSyClWN488bGSNubdX5V63u4j_HRT8jUdif4",
    authDomain: "maps-46c58.firebaseapp.com",
    projectId: "maps-46c58",
    storageBucket: "maps-46c58.firebasestorage.app",
    messagingSenderId: "334648884277",
    appId: "1:334648884277:web:acbcc1a3c82b12e7e9c57c",
    measurementId: "G-WVW7W93TB2"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // ======== DOM refs ========
  const emailEl = document.getElementById('email');
  const passwordEl = document.getElementById('password');
  const signupBtn = document.getElementById('signupBtn');
  const loginBtn = document.getElementById('loginBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const whoami = document.getElementById('whoami');
  const profileRow = document.getElementById('profileRow');
  const displayNameEl = document.getElementById('displayName');
  const saveNameBtn = document.getElementById('saveNameBtn');
  const statusInput = document.getElementById('statusInput');
  const saveStatusBtn = document.getElementById('saveStatusBtn');
  const goLiveBtn = document.getElementById('goLiveBtn');
  const stopBtn = document.getElementById('stopBtn');
  const hintHttps = document.getElementById('hintHttps');

  const toastEl = document.getElementById('toast');
  const statusBanner = document.getElementById('statusBanner');

  // ======== Toasts ========
  let toastTimer = null;
  function toast(msg, ms = 2600) {
    if (!toastEl) return alert(msg);
    toastEl.textContent = msg;
    toastEl.style.opacity = '1';
    toastEl.style.transform = 'translateX(-50%) translateY(0)';
    clearTimeout(toastTimer); toastTimer = setTimeout(() => {
      toastEl.style.opacity = '0';
      toastEl.style.transform = 'translateX(-50%) translateY(20px)';
    }, ms);
  }

  // ======== Ding + vibrate ========
  function playDing() {
    try {
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.connect(g); g.connect(ctx.destination);
      o.type = 'sine'; o.frequency.value = 880; // A5
      g.gain.setValueAtTime(0.001, ctx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.3, ctx.currentTime + 0.01);
      g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.15);
      o.start(); o.stop(ctx.currentTime + 0.16);
    } catch (e) { /* ignore */ }
  }
  function vibrate(pattern = [120, 60, 120]) {
    if ('vibrate' in navigator) navigator.vibrate(pattern);
  }

  // ======== Helpers ========
  function secureOriginOK() { return location.protocol === 'https:' || location.hostname === 'localhost'; }
  function deriveNameFromEmail(email) { return (email || '').split('@')[0] || 'User'; }
  const throttle = (fn, wait) => { let last = 0; let timer = null; let lastArgs; return function(...args){ const now = Date.now(); lastArgs = args; if (now - last >= wait) { last = now; fn.apply(this, args); } else if (!timer) { timer = setTimeout(() => { last = Date.now(); timer = null; fn.apply(this, lastArgs); }, wait - (now - last)); } } }

  // ======== Leaflet map (create ASAP) ========
  const map = L.map('map', { zoomControl: true, minZoom: 2, maxZoom: 20 });
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap contributors' }).addTo(map);
  map.setView([43.6532, -79.3832], 11); // GTA default

  // Marker management (create BEFORE any function that uses markers)
  const markers = new Map(); // uid -> L.Marker
  function makeLabelHTML(name, me=false){ return `<span class="dot-label ${me? 'me':''}"><span class="dot-circle"></span>${name}</span>`; }
  function upsertMarker(uid, name, lat, lng, isMe=false) {
    const key = uid; const icon = L.divIcon({ className: '', html: makeLabelHTML(name, isMe) });
    if (markers.has(key)) { const m = markers.get(key); m.setLatLng([lat, lng]); m.setIcon(icon); }
    else { const m = L.marker([lat, lng], { icon }).addTo(map); markers.set(key, m); }
    return markers.get(key);
  }
  function removeMarker(uid){ const m = markers.get(uid); if (!m) return; map.removeLayer(m); markers.delete(uid); }

  // ======== Status banner (fallback) ========
  let bannerTimer = null;
  function showStatusBanner(name, statusText, ms = 4500) {
    const text = statusText ? `üóíÔ∏è ${name}'s status: ‚Äú${statusText}‚Äù` : `üóíÔ∏è ${name} has no status`;
    statusBanner.textContent = text; statusBanner.style.opacity = '1'; statusBanner.style.transform = 'translateX(-50%) translateY(0)';
    clearTimeout(bannerTimer); bannerTimer = setTimeout(hideStatusBanner, ms);
  }
  function hideStatusBanner() { statusBanner.style.opacity = '0'; statusBanner.style.transform = 'translateX(-50%) translateY(-20px)'; }

  // ======== Map-anchored status popup (defined AFTER map/markers) ========
  let statusPopupTimer = null;
  function showStatusAtLatLng(latlng, name, statusText, ms = 4500) {
    if (!latlng) { showStatusBanner(name, statusText, ms); return; }
    const safeStatus = (statusText || '').replace(/</g,'&lt;');
    const html = `<div><div><strong>${name}</strong></div><div class="muted">${safeStatus || 'No status'}</div></div>`;
    const popup = L.popup({ autoPan: true, closeButton: false, autoClose: true, className: 'status-pop', offset: [0, -16] })
      .setLatLng(latlng).setContent(html);
    map.openPopup(popup);
    clearTimeout(statusPopupTimer); statusPopupTimer = setTimeout(() => { map.closePopup(popup); }, ms);
  }
  function showStatusAtMarker(uid, fallbackLatLng, name, statusText, ms = 4500) {
    const m = markers.get(uid); const ll = m?.getLatLng?.() || fallbackLatLng || null; showStatusAtLatLng(ll, name, statusText, ms);
  }

  // ======== Firestore: my user/profile ========
  async function loadMyProfile(uid) {
    const snap = await getDoc(doc(db, 'users', uid));
    const data = snap.exists() ? snap.data() : {};
    displayNameEl.value = data.name || '';
    statusInput.value = data.status || '';
    return data;
  }
  async function saveName(uid, name) { await setDoc(doc(db, 'users', uid), { name }, { merge: true }); }
  async function saveStatus(uid, status) { await setDoc(doc(db, 'users', uid), { status }, { merge: true }); }
  async function getUser(uid) { const s = await getDoc(doc(db, 'users', uid)); return s.exists()? s.data() : {}; }

  // ======== Presence ========
  let watchId = null; let myUid = null; const presenceDocRef = () => doc(db, 'presence', myUid);
  const writePresence = throttle(async (pos) => {
    if (!myUid) return;
    const { latitude: lat, longitude: lng } = pos.coords;
    const name = (displayNameEl.value || whoami.dataset.emailPrefix || 'Me').trim();
    await setDoc(presenceDocRef(), { lat, lng, name, updatedAt: serverTimestamp() }, { merge: true });
    upsertMarker(myUid, name || 'Me', lat, lng, true);
  }, 250);
  function startWatch() {
    if (!secureOriginOK()) { toast('Use HTTPS or http://localhost for precise GPS'); }
    if (watchId != null) return; if (!auth.currentUser) { toast('Please sign in first.'); return; }
    navigator.geolocation.getCurrentPosition((pos) => { map.setView([pos.coords.latitude, pos.coords.longitude], 16); }, (err) => console.warn(err), { enableHighAccuracy: true, timeout: 10000, maximumAge: 1000 });
    watchId = navigator.geolocation.watchPosition(writePresence, (err) => { console.warn('watchPosition error', err); toast('Location error: ' + err.message); }, { enableHighAccuracy: true, timeout: 10000, maximumAge: 1000 });
    goLiveBtn.style.display = 'none'; stopBtn.style.display = 'inline-block';
  }
  async function stopWatch() { if (watchId != null) { navigator.geolocation.clearWatch(watchId); watchId = null; } if (myUid) { try { await deleteDoc(presenceDocRef()); } catch (e) {} } stopBtn.style.display = 'none'; goLiveBtn.style.display = 'inline-block'; }
  window.addEventListener('beforeunload', () => { if (watchId != null) navigator.geolocation.clearWatch(watchId); });
  document.addEventListener('visibilitychange', async () => { if (document.visibilityState === 'hidden') { try { if (myUid) await deleteDoc(presenceDocRef()); } catch(e){} } });

  // Listen to presence and render others
  let presenceUnsub = null;
  function subscribePresence() {
    if (presenceUnsub) presenceUnsub();
    presenceUnsub = onSnapshot(collection(db, 'presence'), async (snap) => {
      const now = Date.now(); const seen = new Set();
      for (const d of snap.docs) {
        const uid = d.id; const data = d.data();
        const ts = data.updatedAt?.toMillis?.() ?? 0; if (now - ts > 30_000) continue;
        if (!Number.isFinite(data.lat) || !Number.isFinite(data.lng)) continue;
        const name = (uid === myUid) ? (displayNameEl.value || 'Me') : (data.name || 'User');
        const marker = upsertMarker(uid, name, data.lat, data.lng, uid === myUid);
        seen.add(uid);
        if (uid !== myUid && !marker._pokeBound) {
          marker._pokeBound = true;
          marker.on('click', async () => {
            try { const other = await getUser(uid); showStatusAtMarker(uid, marker.getLatLng(), other.name || name || 'User', other.status || ''); }
            catch { showStatusAtMarker(uid, marker.getLatLng(), name || 'User', ''); }
            await sendPoke(uid, name);
          });
        }
      }
      for (const [uid] of markers) { if (!seen.has(uid)) removeMarker(uid); }
    }, (err) => { console.error('presence onSnapshot error', err); toast('Presence error: ' + err.message); });
  }

  // ======== Pokes ========
  async function sendPoke(targetUid, targetName) {
    const me = auth.currentUser; if (!me) return toast('Sign in to poke.');
    const myUser = await getUser(me.uid); const myStatus = myUser.status || '';
    const myLatLng = markers.get(me.uid)?.getLatLng?.();
    await addDoc(collection(db, 'pokes'), { toUid: targetUid, fromUid: me.uid, fromName: myUser.name || deriveNameFromEmail(me.email), fromStatus: myStatus, fromLat: myLatLng?.lat ?? null, fromLng: myLatLng?.lng ?? null, createdAt: serverTimestamp(), handled: false });
  }
  let pokesUnsub = null;
  function startPokeListener(myUid_) {
    if (pokesUnsub) pokesUnsub();
    const qy = query(collection(db, 'pokes'), where('toUid', '==', myUid_), orderBy('createdAt', 'desc'), limit(10));
    pokesUnsub = onSnapshot(qy, (snap) => {
      snap.docChanges().forEach(async (ch) => {
        if (ch.type !== 'added') return; const id = ch.doc.id; const p = ch.doc.data(); if (p.handled === true) return;
        vibrate([120,60,120]); playDing(); toast(`${p.fromName} poked you`);
        try { await updateDoc(doc(db, 'pokes', id), { handled: true }); } catch (e) {}
        setTimeout(() => { const ll = (markers.get(p.fromUid)?.getLatLng?.()) || ((p.fromLat!=null && p.fromLng!=null) ? L.latLng(p.fromLat, p.fromLng) : null); showStatusAtLatLng(ll, p.fromName || 'Someone', p.fromStatus || ''); }, 350);
      });
    }, (err) => { console.error('pokes onSnapshot error', err); toast('Pokes error: ' + err.message); });
  }

  // ======== Auth UI ========
  signupBtn.addEventListener('click', async () => {
    try { await createUserWithEmailAndPassword(auth, emailEl.value.trim(), passwordEl.value.trim()); toast('Account created. You can set your display name.'); }
    catch (e) { toast(e.message); }
  });
  loginBtn.addEventListener('click', async () => {
    try { await signInWithEmailAndPassword(auth, emailEl.value.trim(), passwordEl.value.trim()); }
    catch (e) { toast(e.message); }
  });
  logoutBtn.addEventListener('click', async () => { await stopWatch(); await signOut(auth); });
  saveNameBtn.addEventListener('click', async () => { const u = auth.currentUser; if (!u) return toast('Sign in first.'); const name = (displayNameEl.value || '').trim(); await saveName(u.uid, name); toast('Name saved'); });
  saveStatusBtn.addEventListener('click', async () => { const u = auth.currentUser; if (!u) return toast('Sign in first.'); const status = (statusInput.value || '').trim(); await saveStatus(u.uid, status); toast('Status saved'); });
  goLiveBtn.addEventListener('click', startWatch);
  stopBtn.addEventListener('click', stopWatch);
  if (!secureOriginOK()) { hintHttps.textContent = 'Tip: Use HTTPS or http://localhost for precise GPS'; }

  // ======== Auth state ========
  onAuthStateChanged(auth, async (user) => {
    try {
      if (user) {
        myUid = user.uid; const emailPrefix = deriveNameFromEmail(user.email || ''); whoami.dataset.emailPrefix = emailPrefix;
        whoami.textContent = `Logged in as ${user.email}`; whoami.style.display = 'inline'; logoutBtn.style.display = 'inline-block'; profileRow.style.display = 'flex';
        const me = await loadMyProfile(user.uid); if (!displayNameEl.value) displayNameEl.value = me.name || emailPrefix;
        subscribePresence(); startPokeListener(user.uid);
      } else {
        myUid = null; whoami.textContent = ''; whoami.style.display = 'none'; logoutBtn.style.display = 'none'; profileRow.style.display = 'none';
        stopWatch(); for (const [uid, m] of markers) { map.removeLayer(m); } markers.clear(); if (presenceUnsub) { presenceUnsub(); presenceUnsub = null; } if (pokesUnsub) { pokesUnsub(); pokesUnsub = null; }
      }
    } catch (e) { console.error('Auth state handler error', e); toast('Auth error: ' + e.message); }
  });
</script>
</body>
</html>
