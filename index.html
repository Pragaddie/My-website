<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Live Location ‚Äî Blue Dot + Name</title>

<link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet"/>
<script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>

<script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore-compat.js"></script>

<style>
  :root { --bg:#0b0f16; --panel:#101827; --muted:#9aa3b2; --text:#e6e8ee; }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font:14px system-ui,-apple-system,Segoe UI,Roboto,Arial}
  #map{height:100%}
  header{
    position:fixed; inset:0 0 auto 0; height:64px; display:flex; align-items:center; gap:8px;
    padding:8px 12px; background:rgba(10,15,25,.7); backdrop-filter:blur(6px); border-bottom:1px solid #132037; z-index:5;
  }
  .brand{font-weight:700}
  .spacer{flex:1}
  .btn{background:#0f172a;border:1px solid #1f2937;color:#e6e8ee;padding:8px 12px;border-radius:10px;cursor:pointer}
  .btn[disabled]{opacity:.6;cursor:not-allowed}
  .field{padding:8px 10px;border-radius:10px;border:1px solid #243045;background:#0f172a;color:#e6e8ee}
  .pill{background:#0f172a;border:1px solid #1f2937;color:#9aa3af;padding:6px 10px;border-radius:999px}
  .panel{
    position:fixed; right:12px; bottom:12px; z-index:5; background:var(--panel); border:1px solid #1a2335; border-radius:14px; padding:10px;
  }
  .auth-card{
    position:fixed; inset:64px 0 0 0; display:flex; align-items:center; justify-content:center;
  }
  .card{background:var(--panel); border:1px solid #1a2335; border-radius:14px; padding:16px; width:min(420px,92%)}
  .row{display:flex; gap:8px; align-items:center}
  .col{display:flex; flex-direction:column; gap:8px}
  .toast{
    position:fixed; left:50%; bottom:16px; transform:translateX(-50%);
    background:#0f172a; color:#e6e8ee; border:1px solid #1f2937; padding:8px 12px; border-radius:10px; z-index:99;
  }
</style>
</head>
<body>

<header>
  <div class="brand">LiveMap</div>
  <div class="spacer"></div>

  <div id="authControls" class="row" style="display:none">
    <input id="displayName" class="field" placeholder="Display name" style="min-width:160px"/>
    <button id="saveName" class="btn" type="button">üíæ Save</button>
    <button id="goLive" class="btn" type="button">‚ñ∂ Go live</button>
    <button id="stopLive" class="btn" type="button" disabled>‚èπ Stop</button>
    <button id="logout" class="btn" type="button">üö™ Log out</button>
    <span id="status" class="pill">Signed in</span>
  </div>
</header>

<div id="authScreen" class="auth-card">
  <div class="card">
    <h3 style="margin:0 0 8px">Sign in</h3>
    <div class="col">
      <input id="email" class="field" type="email" placeholder="Email"/>
      <input id="pass"  class="field" type="password" placeholder="Password"/>
      <div class="row">
        <button id="loginBtn"  class="btn" type="button">Log in</button>
        <button id="signupBtn" class="btn" type="button">Create account</button>
      </div>
      <div id="authErr" style="color:#fca5a5"></div>
      <div style="color:var(--muted)">On first signup, you can set your display name after login (top right).</div>
    </div>
  </div>
</div>

<div id="map"></div>

<div class="panel" id="legend" style="display:none">
  <div><b>How it works</b></div>
  <div>‚Ä¢ Log in ‚Üí set your display name ‚Üí <b>Go live</b></div>
  <div>‚Ä¢ Your dot + name shows immediately</div>
  <div>‚Ä¢ Other live users appear too</div>
  <div>‚Ä¢ Stop/Logout/Close tab ‚Üí you disappear</div>
</div>

<div id="toast" class="toast" style="display:none"></div>

<script>
  // --- helpers ---
  const SECURE = location.protocol==='https:' || location.hostname==='localhost';
  function showToast(msg){ const t=document.getElementById('toast'); t.textContent=msg; t.style.display='block'; setTimeout(()=>t.style.display='none',2200); }
  if(!SECURE) showToast('Tip: use HTTPS or http://localhost for precise GPS');

  // --- Firebase (your project: maps-46c58) ---
  const firebaseConfig = {
    apiKey: "AIzaSyClWN488bGSNubdX5V63u4j_HRT8jUdif4",
    authDomain: "maps-46c58.firebaseapp.com",
    projectId: "maps-46c58",
    storageBucket: "maps-46c58.firebasestorage.app",
    messagingSenderId: "334648884277",
    appId: "1:334648884277:web:acbcc1a3c82b12e7e9c57c",
    measurementId: "G-WVW7W93TB2"
  };
  firebase.initializeApp(firebaseConfig);
  const auth=firebase.auth(), db=firebase.firestore();

  // --- DOM ---
  const $ = (id)=>document.getElementById(id);
  const authScreen=$('authScreen'), authControls=$('authControls'), legend=$('legend');
  const email=$('email'), pass=$('pass'), loginBtn=$('loginBtn'), signupBtn=$('signupBtn'), authErr=$('authErr');
  const displayName=$('displayName'), saveName=$('saveName'), goLive=$('goLive'), stopLive=$('stopLive'), logout=$('logout'), statusEl=$('status');

  // --- Map ---
  let map, mapLoaded=false;
  function setupMap(){
    if (map) return;
    map = new maplibregl.Map({
      container:'map',
      style:{
        version:8,
        glyphs:"https://demotiles.maplibre.org/font/{fontstack}/{range}.pbf",
        sources:{
          osm:{ type:'raster', tiles:["https://tile.openstreetmap.org/{z}/{x}/{y}.png"], tileSize:256, attribution:"¬© OpenStreetMap contributors" }
        },
        layers:[{ id:'osm', type:'raster', source:'osm' }]
      },
      center:[-79.3832,43.6532], zoom:15
    });
    map.addControl(new maplibregl.NavigationControl(), "top-right");
    map.on('load', ()=>{ mapLoaded=true; ensureMeLayers(); ensureOthersLayers(); renderMe(); renderOthers(); });
  }

  // Separate sources/layers for ME and OTHERS
  function ensureMeLayers(){
    if (!map.getSource('me')){
      map.addSource('me',{type:'geojson',data:{type:'FeatureCollection',features:[]}});
    }
    if (!map.getLayer('me-halo')){
      map.addLayer({ id:'me-halo', type:'circle', source:'me',
        paint:{ 'circle-radius':16, 'circle-color':'#2F80ED', 'circle-opacity':0.18 }});
    }
    if (!map.getLayer('me-dot')){
      map.addLayer({ id:'me-dot', type:'circle', source:'me',
        paint:{ 'circle-radius':8, 'circle-color':'#2F80ED', 'circle-stroke-color':'#fff', 'circle-stroke-width':2 }});
    }
    if (!map.getLayer('me-label')){
      map.addLayer({ id:'me-label', type:'symbol', source:'me',
        layout:{
          'text-field':['get','name'],
          'text-font':['Open Sans Regular','Arial Unicode MS Regular'],
          'text-size':12, 'text-offset':[0,1.4], 'text-anchor':'top',
          'text-allow-overlap':true, 'text-ignore-placement':true
        },
        paint:{ 'text-color':'#e6e8ee','text-halo-color':'#0b0f16','text-halo-width':1.2 }});
    }
  }
  function ensureOthersLayers(){
    if (!map.getSource('others')){
      map.addSource('others',{type:'geojson',data:{type:'FeatureCollection',features:[]}});
    }
    if (!map.getLayer('others-halo')){
      map.addLayer({ id:'others-halo', type:'circle', source:'others',
        paint:{ 'circle-radius':16, 'circle-color':'#2F80ED', 'circle-opacity':0.12 }});
    }
    if (!map.getLayer('others-dot')){
      map.addLayer({ id:'others-dot', type:'circle', source:'others',
        paint:{ 'circle-radius':8, 'circle-color':'#2F80ED', 'circle-stroke-color':'#fff', 'circle-stroke-width':2 }});
    }
    if (!map.getLayer('others-label')){
      map.addLayer({ id:'others-label', type:'symbol', source:'others',
        layout:{
          'text-field':['get','name'],
          'text-font':['Open Sans Regular','Arial Unicode MS Regular'],
          'text-size':12, 'text-offset':[0,1.4], 'text-anchor':'top',
          'text-allow-overlap':true, 'text-ignore-placement':true
        },
        paint:{ 'text-color':'#e6e8ee','text-halo-color':'#0b0f16','text-halo-width':1.2 }});
    }
  }

  // --- My state ---
  let me = { uid:null, name:'', live:false, watchId:null, last:[null,null] };

  function deriveName(u, doc){
    if (u?.displayName) return u.displayName;
    if (doc?.exists && doc.data()?.name) return doc.data().name;
    if (u?.email) return u.email.split('@')[0];
    return 'Me';
  }

  function renderMe(){
    if (!mapLoaded) return;
    ensureMeLayers();
    const src=map.getSource('me'); if(!src) return;
    if (me.last[0]==null) { src.setData({type:'FeatureCollection',features:[]}); return; }
    src.setData({
      type:'FeatureCollection',
      features:[{ type:'Feature', properties:{ name: me.name || 'Me' },
        geometry:{ type:'Point', coordinates: me.last }}]
    });
  }

  // --- Others (presence) ---
  const others = new Map(); // uid -> {lng,lat,name,ts}
  let unsubPresence=null;

  function renderOthers(){
    if (!mapLoaded) return;
    ensureOthersLayers();
    const src=map.getSource('others'); if(!src) return;
    const now=Date.now(), feats=[];
    others.forEach((o,uid)=>{ if(now-o.ts>30000) return; feats.push({
      type:'Feature', properties:{ name:o.name||'' }, geometry:{ type:'Point', coordinates:[o.lng,o.lat] }
    }); });
    src.setData({ type:'FeatureCollection', features:feats });
    const count = feats.length + (me.last[0]==null?0:1);
    $('status').textContent = `${me.live ? 'Live' : 'Signed in'} ‚Ä¢ showing ${count} user(s)`;
  }

  function startPresence(){
    if (unsubPresence) return;
    unsubPresence = db.collection('presence').onSnapshot(snap=>{
      const now=Date.now();
      snap.docChanges().forEach(ch=>{
        const uid=ch.doc.id, d=ch.doc.data();
        if (uid===me.uid) return; // skip myself in "others"
        if (!d || typeof d.lat!=='number' || typeof d.lng!=='number') { others.delete(uid); return; }
        const ts = d.updatedAt?.toMillis?.() ? d.updatedAt.toMillis() : now;
        if (ch.type==='removed') others.delete(uid);
        else others.set(uid,{ lng:d.lng, lat:d.lat, name:d.name||'', ts });
      });
      renderOthers();
    });
  }
  function stopPresence(){ if (unsubPresence){ unsubPresence(); unsubPresence=null; } others.clear(); renderOthers(); }

  // --- Auth UI ---
  loginBtn.onclick = async ()=>{
    authErr.textContent=''; loginBtn.disabled=true;
    try{
      if(!email.value.trim()||!pass.value) throw new Error('Enter email and password.');
      await auth.signInWithEmailAndPassword(email.value.trim(), pass.value);
    }catch(e){ authErr.textContent=e.message||String(e); showToast(authErr.textContent); }
    finally{ loginBtn.disabled=false; }
  };
  signupBtn.onclick = async ()=>{
    authErr.textContent=''; signupBtn.disabled=true;
    try{
      if(!email.value.trim()||!pass.value) throw new Error('Enter email and password.');
      const c = await auth.createUserWithEmailAndPassword(email.value.trim(), pass.value);
      // name can be set after login from the header
      await db.collection('users').doc(c.user.uid).set({ name:'' }, {merge:true});
      showToast('Account created. Log in now.');
    }catch(e){ authErr.textContent=e.message||String(e); showToast(authErr.textContent); }
    finally{ signupBtn.disabled=false; }
  };

  // After login
  auth.onAuthStateChanged(async (u)=>{
    if (u){
      const doc = await db.collection('users').doc(u.uid).get();
      me.uid = u.uid;
      me.name = deriveName(u, doc);
      displayName.value = me.name;
      authScreen.style.display='none';
      authControls.style.display='flex';
      legend.style.display='block';
      setupMap();
      statusEl.textContent='Signed in';
    } else {
      await goOffline();
      me={ uid:null, name:'', live:false, watchId:null, last:[null,null] };
      authControls.style.display='none';
      legend.style.display='none';
      authScreen.style.display='flex';
    }
  });

  saveName.onclick = async ()=>{
    if (!auth.currentUser) return;
    const name = (displayName.value||'').trim();
    me.name = name || 'Me';
    try{
      await auth.currentUser.updateProfile({ displayName: me.name });
    }catch(e){}
    await db.collection('users').doc(me.uid).set({ name: me.name }, {merge:true});
    renderMe();
    if (me.live) await db.collection('presence').doc(me.uid).set({ name: me.name, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, {merge:true});
    showToast('Name saved');
  };

  // --- Live on/off ---
  goLive.onclick = async ()=>{ await goOnline(); };
  stopLive.onclick = async ()=>{ await goOffline(); };
  logout.onclick = async ()=>{ await goOffline(); await auth.signOut(); };

  async function goOnline(){
    if (!auth.currentUser) return;
    if (!SECURE) showToast('Use HTTPS or localhost for precise GPS');
    if (me.live) return;

    startPresence(); // start seeing others only while live

    // precision first fix
    navigator.geolocation.getCurrentPosition((pos)=>{
      const {latitude,longitude}=pos.coords;
      me.last=[longitude,latitude];
      renderMe(); if(map) map.jumpTo({center:me.last, zoom:16});
      // write initial presence
      db.collection('presence').doc(me.uid).set({
        lng: longitude, lat: latitude, name: me.name || 'Me',
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      }, {merge:true});
    }, ()=>{}, {enableHighAccuracy:true, timeout:20000, maximumAge:0});

    // continuous updates
    me.watchId = navigator.geolocation.watchPosition(onPos, onErr, {enableHighAccuracy:true, timeout:15000, maximumAge:0});

    goLive.disabled=true; stopLive.disabled=false; me.live=true; statusEl.textContent='Live (sharing)‚Ä¶';
  }

  async function goOffline(){
    if (me.watchId!=null){ navigator.geolocation.clearWatch(me.watchId); me.watchId=null; }
    stopPresence();
    if (me.uid) { try{ await db.collection('presence').doc(me.uid).delete(); }catch(e){} }
    me.live=false; goLive.disabled=false; stopLive.disabled=true; statusEl.textContent = auth.currentUser ? 'Signed in' : 'Signed out';
    // keep my last point locally? up to you‚Äîhere we clear it:
    me.last=[null,null]; renderMe(); renderOthers();
  }

  window.addEventListener('beforeunload', ()=>{ if(me.live && me.uid) db.collection('presence').doc(me.uid).delete(); });

  let writeTimer=null;
  function onPos(pos){
    const { latitude, longitude } = pos.coords;
    me.last=[longitude, latitude];
    renderMe();
    // share to others (throttled)
    clearTimeout(writeTimer);
    writeTimer = setTimeout(()=> {
      db.collection('presence').doc(me.uid).set({
        lng: longitude, lat: latitude, name: me.name || 'Me',
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      }, {merge:true});
    }, 250);
  }
  function onErr(err){ statusEl.textContent = err.message || 'Location error'; showToast(statusEl.textContent); }
</script>
</body>
</html>
