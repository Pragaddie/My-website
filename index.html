<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Live Location ‚Äî Blue Dots with Names</title>

  <!-- MapLibre (CSS/JS) -->
  <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet"/>
  <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore-compat.js"></script>

  <style>
    :root { --bg:#0b0f16; --card:#101827; --muted:#9aa3b2; --text:#e6e8ee; --accent:#2F80ED; }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font:14px system-ui,-apple-system,Segoe UI,Roboto,Arial}
    #app{height:100%;display:flex;flex-direction:column}
    header{
      height:56px;display:flex;align-items:center;gap:8px;padding:8px 12px;border-bottom:1px solid #121a2a;
      background:linear-gradient(180deg,rgba(8,11,18,.95),rgba(8,11,18,.6));backdrop-filter:blur(6px);z-index:10
    }
    header .brand{font-weight:700}
    header .spacer{flex:1}
    .btn{background:#0f172a;border:1px solid #1f2937;color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .pill{background:#0f172a;border:1px solid #1f2937;color:#9aa3af;padding:6px 10px;border-radius:999px}
    #map{flex:1;min-height:0}
    .panel{
      position:fixed;inset:auto 12px 12px auto;width:320px;max-width:calc(100% - 24px);
      background:var(--card);border:1px solid #1a2335;border-radius:16px;padding:12px;z-index:20
    }
    .field{width:100%;padding:10px;border-radius:10px;border:1px solid #243045;background:#0f172a;color:var(--text)}
    .row{display:flex;gap:8px;align-items:center}
    .col{display:flex;flex-direction:column;gap:8px}
    .center{display:flex;align-items:center;justify-content:center;height:100%}
    .card{width:min(420px,92%);background:var(--card);border:1px solid #1a2335;border-radius:16px;padding:16px}
    .link{color:#93c5fd;cursor:pointer}
    .toast{
      position:fixed;bottom:16px;left:50%;transform:translateX(-50%);
      background:#0f172a;border:1px solid #1f2937;color:var(--text);padding:8px 12px;border-radius:10px;z-index:999
    }
    .warn{background:#7c2d12;border-color:#9a3412}
  </style>
</head>
<body>
<div id="app">

  <header>
    <div class="brand">LiveMap</div>
    <div class="spacer"></div>
    <div id="authedControls" style="display:none; gap:8px" class="row">
      <button id="goLiveBtn"  class="btn" type="button">‚ñ∂ Go live</button>
      <button id="stopLiveBtn" class="btn" type="button" disabled>‚èπ Stop</button>
      <button id="followBtn"   class="btn" type="button">üéØ Follow: ON</button>
      <button id="logoutBtn"   class="btn" type="button">üö™ Log out</button>
      <span id="status" class="pill">Signed in</span>
    </div>
  </header>

  <!-- AUTH SCREENS -->
  <div id="authScreens" class="center">
    <!-- LOGIN -->
    <div id="loginCard" class="card">
      <h3 style="margin:0 0 8px">Log in</h3>
      <div class="col">
        <input id="loginEmail" class="field" type="email" placeholder="Email"/>
        <input id="loginPass"  class="field" type="password" placeholder="Password"/>
        <button id="loginBtn"  class="btn" type="button">Log in</button>
        <div style="color:var(--muted)">No account? <span id="toSignup" class="link">Create one</span></div>
        <div id="loginErr" style="color:#fca5a5"></div>
      </div>
    </div>
    <!-- SIGNUP -->
    <div id="signupCard" class="card" style="display:none">
      <h3 style="margin:0 0 8px">Create account</h3>
      <div class="col">
        <input id="suName"  class="field" placeholder="Display name (shown above your dot)"/>
        <input id="suEmail" class="field" type="email" placeholder="Email"/>
        <input id="suPass"  class="field" type="password" placeholder="Password (min 6 chars)"/>
        <button id="signupBtn" class="btn" type="button">Sign up</button>
        <div style="color:var(--muted)">Have an account? <span id="toLogin" class="link">Log in</span></div>
        <div id="signupErr" style="color:#fca5a5"></div>
      </div>
    </div>
  </div>

  <!-- MAP -->
  <div id="map" style="display:none"></div>

  <!-- Legend -->
  <div id="legend" class="panel" style="display:none">
    <div class="col">
      <div><b>How it works</b></div>
      <div class="row"><span class="pill">1</span> Log in / Create account</div>
      <div class="row"><span class="pill">2</span> Click <b>Go live</b> (allow location)</div>
      <div class="row"><span class="pill">3</span> See all other live users as <b>blue dots</b> with their display names</div>
      <div class="row"><span class="pill">4</span> Stop / Log out / close tab ‚Üí you disappear</div>
    </div>
  </div>

</div>

<script>
  // ---------- helpers ----------
  const SECURE_OK = location.protocol === 'https:' || location.hostname === 'localhost';
  function toast(msg, warn=false){
    const t=document.createElement('div'); t.className='toast'+(warn?' warn':''); t.textContent=msg;
    document.body.appendChild(t); setTimeout(()=>t.remove(), 2600);
  }

  // ---------- Firebase config (REPLACE placeholders) ----------
  const firebaseConfig = {
  apiKey: "AIzaSyClWN488bGSNubdX5V63u4j_HRT8jUdif4",
  authDomain: "maps-46c58.firebaseapp.com",
  projectId: "maps-46c58",
  storageBucket: "maps-46c58.firebasestorage.app",
  messagingSenderId: "334648884277",
  appId: "1:334648884277:web:acbcc1a3c82b12e7e9c57c",
  measurementId: "G-WVW7W93TB2"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db   = firebase.firestore();

  // Config sanity check
  const cfg = firebase?.app()?.options || {};
  if (!cfg.apiKey || String(cfg.apiKey).includes('PASTE_YOUR_KEY')) {
    toast('Firebase config missing/placeholder. Paste your real config.', true);
    console.error('Firebase config problem:', cfg);
  }

  // ---------- DOM refs ----------
  const $ = (id)=>document.getElementById(id);
  const authScreens=$('authScreens'), loginCard=$('loginCard'), signupCard=$('signupCard');
  const mapDiv=$('map'), legend=$('legend'), authedCtrls=$('authedControls');
  const loginEmail=$('loginEmail'), loginPass=$('loginPass'), loginBtn=$('loginBtn'), loginErr=$('loginErr');
  const suName=$('suName'), suEmail=$('suEmail'), suPass=$('suPass'), signupBtn=$('signupBtn'), signupErr=$('signupErr');
  const toSignup=$('toSignup'), toLogin=$('toLogin');
  const goLiveBtn=$('goLiveBtn'), stopLiveBtn=$('stopLiveBtn'), followBtn=$('followBtn'), logoutBtn=$('logoutBtn'), statusEl=$('status');

  // Attach click handlers ASAP (so a map error can't block auth UI)
  window.addEventListener('DOMContentLoaded', () => {
    toSignup.addEventListener('click', ()=>{ loginCard.style.display='none'; signupCard.style.display='block'; });
    toLogin .addEventListener('click', ()=>{ signupCard.style.display='none'; loginCard.style.display='block'; });

    loginBtn.addEventListener('click', onLogin);
    signupBtn.addEventListener('click', onSignup);
    logoutBtn.addEventListener('click', async ()=>{ await stopLive(); await auth.signOut(); });

    goLiveBtn.addEventListener('click', startLive);
    stopLiveBtn.addEventListener('click', stopLive);
    followBtn.addEventListener('click', ()=>{
      my.follow = !my.follow;
      followBtn.textContent = `üéØ Follow: ${my.follow ? 'ON' : 'OFF'}`;
      if (my.follow && my.lastLL) map?.easeTo({ center: my.lastLL, duration: 500 });
    });
  });

  // ---------- Auth handlers ----------
  async function onLogin(){
    loginErr.textContent=''; loginBtn.disabled=true;
    try{
      const email=loginEmail.value.trim(), pass=loginPass.value;
      if(!email||!pass) throw new Error('Enter email and password.');
      await auth.signInWithEmailAndPassword(email, pass);
    }catch(e){ loginErr.textContent = e.message || String(e); toast(loginErr.textContent, true); }
    finally{ loginBtn.disabled=false; }
  }
  async function onSignup(){
    signupErr.textContent=''; signupBtn.disabled=true;
    try{
      const name=suName.value.trim(), email=suEmail.value.trim(), pass=suPass.value;
      if(!name) throw new Error('Please enter a display name.');
      if(!email||!pass) throw new Error('Enter email and password.');
      const cred = await auth.createUserWithEmailAndPassword(email, pass);
      await cred.user.updateProfile({ displayName: name });
      await db.collection('users').doc(cred.user.uid).set({ name }, { merge:true });
      // switch to login view automatically
      signupCard.style.display='none'; loginCard.style.display='block';
      toast('Account created. Please log in.');
    }catch(e){ signupErr.textContent = e.message || String(e); toast(signupErr.textContent, true); }
    finally{ signupBtn.disabled=false; }
  }

  // ---------- Map setup (safe) ----------
  let map, mapLoaded=false;
  function setupMapOnce(){
    if (map) return;
    if (!window.maplibregl){ toast('Map library failed to load. Check network/CSP.', true); return; }
    try{
      map = new maplibregl.Map({
        container: "map",
        style: {
          "version": 8,
          "glyphs": "https://demotiles.maplibre.org/font/{fontstack}/{range}.pbf",
          "sources": {
            "osm": { "type":"raster", "tiles":["https://tile.openstreetmap.org/{z}/{x}/{y}.png"], "tileSize":256, "attribution":"¬© OpenStreetMap contributors" }
          },
          "layers": [{ "id":"osm", "type":"raster", "source":"osm" }]
        },
        center: [-79.3832, 43.6532],
        zoom: 15
      });
      map.addControl(new maplibregl.NavigationControl(), "top-right");
      map.on('load', () => {
        mapLoaded=true;
        map.addSource('people', { type:'geojson', data:{ type:'FeatureCollection', features:[] }});
        map.addLayer({ id:'people-accuracy', type:'fill', source:'people', filter:['==',['get','kind'],'acc'],
          paint:{ 'fill-color':'#2F80ED', 'fill-opacity':0.15 }});
        map.addLayer({ id:'people-dots', type:'circle', source:'people', filter:['==',['get','kind'],'point'],
          paint:{ 'circle-radius':8, 'circle-color':'#2F80ED', 'circle-stroke-color':'#fff', 'circle-stroke-width':2 }});
        map.addLayer({ id:'people-labels', type:'symbol', source:'people', filter:['==',['get','kind'],'point'],
          layout:{ 'text-field':['get','name'], 'text-font':['Open Sans Semibold','Arial Unicode MS Regular'],
                   'text-size':12, 'text-offset':[0,1.4], 'text-anchor':'top',
                   'text-allow-overlap':true, 'text-ignore-placement':true },
          paint:{ 'text-color':'#e6e8ee', 'text-halo-color':'#0b0f16', 'text-halo-width':1.2 }});
        renderPeople(); // in case we had data
      });
    }catch(err){
      console.error(err); toast('Map failed to initialize: '+(err.message||err), true);
    }
  }

  // ---------- People rendering ----------
  const users = new Map(); // uid -> {lng,lat,name,acc,ts}
  function circlePolygon([lng,lat], radiusMeters){
    const steps=64, pts=[]; const R=6378137;
    const dLng=m=>(m/(R*Math.cos(lat*Math.PI/180)))*(180/Math.PI);
    const dLat=m=>(m/R)*(180/Math.PI);
    for(let i=0;i<=steps;i++){ const a=(i/steps)*Math.PI*2; pts.push([ lng+dLng(Math.sin(a)*radiusMeters), lat+dLat(Math.cos(a)*radiusMeters) ]); }
    return pts;
  }
  function renderPeople(){
    if (!mapLoaded) return;
    const src = map.getSource('people'); if (!src) return;
    const now=Date.now(), feats=[];
    users.forEach((u,uid)=>{
      if (now-u.ts>30000) return;
      const acc=Math.max(0,Number(u.acc||0));
      if (acc>0) feats.push({ type:'Feature', properties:{uid,kind:'acc'}, geometry:{ type:'Polygon', coordinates:[circlePolygon([u.lng,u.lat], acc)] }});
      feats.push({ type:'Feature', properties:{uid,kind:'point',name:u.name||''}, geometry:{ type:'Point', coordinates:[u.lng,u.lat] }});
    });
    src.setData({ type:'FeatureCollection', features:feats });
  }

  // ---------- Auth state ----------
  let my = { uid:null, name:'', live:false, watchId:null, follow:true, lastLL:null };
  let presenceUnsub = null;

  function deriveName(user, doc){
    if (user?.displayName) return user.displayName;
    if (doc?.exists && doc.data()?.name) return doc.data().name;
    if (user?.email) return user.email.split('@')[0];
    return 'Me';
  }

  auth.onAuthStateChanged(async (user)=>{
    console.log('Auth state:', !!user);
    if (user){
      const prof = await db.collection('users').doc(user.uid).get();
      my.uid = user.uid;
      my.name = deriveName(user, prof);
      await db.collection('users').doc(user.uid).set({ name: my.name }, { merge:true });

      authScreens.style.display='none';
      mapDiv.style.display='block';
      legend.style.display='block';
      authedCtrls.style.display='flex';
      statusEl.textContent='Signed in';

      setupMapOnce(); // safe init (after auth UI shows)
    } else {
      await stopLive();
      users.clear(); renderPeople();
      authedCtrls.style.display='none';
      mapDiv.style.display='none';
      legend.style.display='none';
      authScreens.style.display='flex';
      signupCard.style.display='none';
      loginCard.style.display='block';
    }
  });

  // ---------- Live location / presence ----------
  function startPresenceListener(){
    if (presenceUnsub) return;
    presenceUnsub = db.collection('presence').onSnapshot((snap)=>{
      const now = Date.now();
      snap.docChanges().forEach(ch=>{
        const uid=ch.doc.id, d=ch.doc.data();
        if (!d || typeof d.lat!=='number' || typeof d.lng!=='number') { users.delete(uid); return; }
        const ts = d.updatedAt?.toMillis?.() ? d.updatedAt.toMillis() : now;
        if (ch.type==='removed') users.delete(uid);
        else users.set(uid, { lng:d.lng, lat:d.lat, acc:d.acc||0, name:d.name||'', ts });
      });
      renderPeople();
    });
  }
  function stopPresenceListener(){ if (presenceUnsub){ presenceUnsub(); presenceUnsub=null; } }

  async function startLive(){
    if (!auth.currentUser) return;
    if (!SECURE_OK) toast('Use HTTPS or http://localhost for precise GPS.', true);
    if (my.watchId != null) return;

    startPresenceListener(); // only while I'm live

    // Instant first fix try
    navigator.geolocation.getCurrentPosition(
      (pos)=>onPos(pos,true),
      ()=>{},
      { enableHighAccuracy:true, timeout:20000, maximumAge:0 }
    );
    my.watchId = navigator.geolocation.watchPosition(onPos, onErr, { enableHighAccuracy:true, maximumAge:0, timeout:15000 });

    goLiveBtn.disabled=true; stopLiveBtn.disabled=false;
    statusEl.textContent='Live (sharing)‚Ä¶';
    my.live=true;
  }

  async function stopLive(){
    if (my.watchId != null){ navigator.geolocation.clearWatch(my.watchId); my.watchId=null; }
    if (my.uid){ try{ await db.collection('presence').doc(my.uid).delete(); }catch(e){} }
    stopPresenceListener();
    users.delete(my.uid); renderPeople();
    goLiveBtn.disabled=false; stopLiveBtn.disabled=true;
    statusEl.textContent = auth.currentUser ? 'Signed in' : 'Signed out';
    my.live=false;
  }

  window.addEventListener('beforeunload', ()=>{ if (my.live && my.uid) db.collection('presence').doc(my.uid).delete(); });

  let writeTimer=null;
  function onPos(pos, first=false){
    const { latitude, longitude, accuracy } = pos.coords;
    my.lastLL=[longitude, latitude];

    const display = (my.name && my.name.trim()) ? my.name : (auth.currentUser?.email ? auth.currentUser.email.split('@')[0] : 'Me');
    users.set(my.uid, { lng:longitude, lat:latitude, acc:accuracy||0, name:display, ts:Date.now() });
    renderPeople();
    if (my.follow || first) map?.easeTo({ center:[longitude, latitude], duration: first?0:400 });
    statusEl.textContent = `Live ‚Ä¢ ¬±${Math.round(accuracy||0)} m`;

    clearTimeout(writeTimer);
    writeTimer = setTimeout(()=> {
      db.collection('presence').doc(my.uid).set({
        lat: latitude, lng: longitude, acc: accuracy||0, name: display,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge:true });
    }, 300);
  }
  function onErr(err){
    statusEl.textContent = err.message || 'Location error';
    if (err.code === 1) toast('Allow location permissions.', true);
  }

  // Friendly reminder about secure context
  if (!SECURE_OK) toast('Tip: host on HTTPS or use http://localhost', true);
</script>
</body>
</html>
