<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Live Location ‚Äî Blue Dots with Names</title>

  <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet"/>
  <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>

  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore-compat.js"></script>

  <style>
    :root { --bg:#0b0f16; --card:#101827; --muted:#9aa3b2; --text:#e6e8ee; --accent:#2F80ED; }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font:14px system-ui,-apple-system,Segoe UI,Roboto,Arial}
    #app{height:100%;display:flex;flex-direction:column}
    header{
      height:56px;display:flex;align-items:center;gap:8px;padding:8px 12px;border-bottom:1px solid #121a2a;
      background:linear-gradient(180deg,rgba(8,11,18,.95),rgba(8,11,18,.6));backdrop-filter:blur(6px);z-index:10
    }
    header .brand{font-weight:700}
    header .spacer{flex:1}
    .btn{background:#0f172a;border:1px solid #1f2937;color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .pill{background:#0f172a;border:1px solid #1f2937;color:#9aa3af;padding:6px 10px;border-radius:999px}
    #map{flex:1;min-height:0}
    .panel{
      position:fixed;inset:auto 12px 12px auto;width:320px;max-width:calc(100% - 24px);
      background:var(--card);border:1px solid #1a2335;border-radius:16px;padding:12px;z-index:20
    }
    .field{width:100%;padding:10px;border-radius:10px;border:1px solid #243045;background:#0f172a;color:var(--text)}
    .row{display:flex;gap:8px;align-items:center}
    .col{display:flex;flex-direction:column;gap:8px}
    .center{display:flex;align-items:center;justify-content:center;height:100%}
    .card{width:min(420px,92%);background:var(--card);border:1px solid #1a2335;border-radius:16px;padding:16px}
    .link{color:#93c5fd;cursor:pointer}
    .toast{
      position:fixed;bottom:16px;left:50%;transform:translateX(-50%);
      background:#0f172a;border:1px solid #1f2937;color:var(--text);padding:8px 12px;border-radius:10px;z-index:999
    }
    .warn{background:#7c2d12;border-color:#9a3412}
  </style>
</head>
<body>
<div id="app">

  <header>
    <div class="brand">LiveMap</div>
    <div class="spacer"></div>
    <div id="authedControls" style="display:none; gap:8px" class="row">
      <button id="goLiveBtn" class="btn">‚ñ∂ Go live</button>
      <button id="stopLiveBtn" class="btn" disabled>‚èπ Stop</button>
      <button id="followBtn" class="btn">üéØ Follow: ON</button>
      <button id="logoutBtn" class="btn">üö™ Log out</button>
      <span id="status" class="pill">Signed in</span>
    </div>
  </header>

  <!-- AUTH SCREENS -->
  <div id="authScreens" class="center">
    <!-- LOGIN -->
    <div id="loginCard" class="card">
      <h3 style="margin:0 0 8px">Log in</h3>
      <div class="col">
        <input id="loginEmail" class="field" type="email" placeholder="Email"/>
        <input id="loginPass" class="field" type="password" placeholder="Password"/>
        <button id="loginBtn" class="btn">Log in</button>
        <div style="color:var(--muted)">No account? <span id="toSignup" class="link">Create one</span></div>
        <div id="loginErr" style="color:#fca5a5"></div>
      </div>
    </div>
    <!-- SIGNUP -->
    <div id="signupCard" class="card" style="display:none">
      <h3 style="margin:0 0 8px">Create account</h3>
      <div class="col">
        <input id="suName"  class="field" placeholder="Display name (shown above your dot)"/>
        <input id="suEmail" class="field" type="email" placeholder="Email"/>
        <input id="suPass"  class="field" type="password" placeholder="Password (min 6 chars)"/>
        <button id="signupBtn" class="btn">Sign up</button>
        <div style="color:var(--muted)">Have an account? <span id="toLogin" class="link">Log in</span></div>
        <div id="signupErr" style="color:#fca5a5"></div>
      </div>
    </div>
  </div>

  <!-- MAP -->
  <div id="map" style="display:none"></div>

  <!-- Legend -->
  <div id="legend" class="panel" style="display:none">
    <div class="col">
      <div><b>How it works</b></div>
      <div class="row"><span class="pill">1</span> Log in / Create account</div>
      <div class="row"><span class="pill">2</span> Click <b>Go live</b> (allow location)</div>
      <div class="row"><span class="pill">3</span> See all other live users as <b>blue dots</b> with their display names</div>
      <div class="row"><span class="pill">4</span> Stop / Log out / close tab ‚Üí you disappear</div>
    </div>
  </div>

</div>

<script>
  // ---- Secure context check ----
  const SECURE_OK = location.protocol === 'https:' || location.hostname === 'localhost';
  function toast(msg, warn=false){
    const t=document.createElement('div'); t.className='toast'+(warn?' warn':''); t.textContent=msg; document.body.appendChild(t);
    setTimeout(()=>t.remove(), 2500);
  }
  if (!SECURE_OK) toast('Use HTTPS or http://localhost ‚Äî precise GPS needs a secure context.', true);

  // ---------------- Firebase ----------------
  const firebaseConfig = {
  apiKey: "AIzaSyClWN488bGSNubdX5V63u4j_HRT8jUdif4",
  authDomain: "maps-46c58.firebaseapp.com",
  projectId: "maps-46c58",
  storageBucket: "maps-46c58.firebasestorage.app",
  messagingSenderId: "334648884277",
  appId: "1:334648884277:web:acbcc1a3c82b12e7e9c57c",
  measurementId: "G-WVW7W93TB2"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db   = firebase.firestore();

  // ---------------- UI helpers ----------------
  const $ = (id)=>document.getElementById(id);

  // Screens
  const authScreens  = $('authScreens');
  const loginCard    = $('loginCard');
  const signupCard   = $('signupCard');
  const mapDiv       = $('map');
  const legend       = $('legend');
  const authedCtrls  = $('authedControls');

  // Auth inputs
  const loginEmail = $('loginEmail'), loginPass = $('loginPass'), loginBtn = $('loginBtn'), loginErr = $('loginErr');
  const suName = $('suName'), suEmail = $('suEmail'), suPass = $('suPass'), signupBtn = $('signupBtn'), signupErr = $('signupErr');
  $('toSignup').onclick = ()=>{ loginCard.style.display='none'; signupCard.style.display='block'; };
  $('toLogin').onclick  = ()=>{ signupCard.style.display='none'; loginCard.style.display='block'; };

  // Authed controls
  const goLiveBtn = $('goLiveBtn'), stopLiveBtn = $('stopLiveBtn'), followBtn = $('followBtn'), logoutBtn = $('logoutBtn'), statusEl = $('status');

  // ---------------- MapLibre setup ----------------
  const map = new maplibregl.Map({
    container: "map",
    style: {
      "version": 8,
      "glyphs": "https://demotiles.maplibre.org/font/{fontstack}/{range}.pbf",   // <-- REQUIRED for text labels
      "sources": {
        "osm": {
          "type": "raster",
          "tiles": ["https://tile.openstreetmap.org/{z}/{x}/{y}.png"],
          "tileSize": 256,
          "attribution": "¬© OpenStreetMap contributors"
        }
      },
      "layers": [{ "id": "osm", "type": "raster", "source": "osm" }]
    },
    center: [-79.3832, 43.6532],
    zoom: 15
  });
  map.addControl(new maplibregl.NavigationControl(), "top-right");

  let mapLoaded = false;
  map.on('load', () => {
    mapLoaded = true;
    map.addSource('people', { type: 'geojson', data: { type: 'FeatureCollection', features: [] } });

    // Accuracy circle (meters -> polygon)
    map.addLayer({
      id: 'people-accuracy',
      type: 'fill',
      source: 'people',
      filter: ['==', ['get','kind'], 'acc'],
      paint: {
        'fill-color': '#2F80ED',
        'fill-opacity': 0.15
      }
    });

    // Blue dot
    map.addLayer({
      id: 'people-dots',
      type: 'circle',
      source: 'people',
      filter: ['==', ['get','kind'], 'point'],
      paint: {
        'circle-radius': 8,
        'circle-color': '#2F80ED',
        'circle-stroke-color': '#ffffff',
        'circle-stroke-width': 2
      }
    });

    // Name labels (hovering above dot)
    map.addLayer({
      id: 'people-labels',
      type: 'symbol',
      source: 'people',
      filter: ['==', ['get','kind'], 'point'],
      layout: {
        'text-field': ['get', 'name'],
        'text-font': ['Open Sans Semibold','Arial Unicode MS Regular'],
        'text-size': 12,
        'text-offset': [0, 1.4],     // move above the dot
        'text-anchor': 'top',
        'text-allow-overlap': true,
        'text-ignore-placement': true
      },
      paint: {
        'text-color': '#e6e8ee',
        'text-halo-color': '#0b0f16',
        'text-halo-width': 1.2
      }
    });

    renderPeople(); // if we had early data
  });

  // In-memory "users" map so we can build both dot + accuracy polygon
  const users = new Map(); // uid -> {lng,lat,name,acc,ts}

  function circlePolygon([lng,lat], radiusMeters){
    const steps = 64, pts = [];
    const R = 6378137;
    const dLng = m => (m / (R * Math.cos(lat*Math.PI/180))) * (180/Math.PI);
    const dLat = m => (m / R) * (180/Math.PI);
    for (let i=0;i<=steps;i++){
      const a = (i/steps) * Math.PI*2;
      pts.push([ lng + dLng(Math.sin(a)*radiusMeters), lat + dLat(Math.cos(a)*radiusMeters) ]);
    }
    return pts;
  }

  function renderPeople(){
    const src = map.getSource('people'); if (!src) return;
    const feats = [];
    const now = Date.now();
    users.forEach((u, uid)=>{
      // Hide stale > 30s
      if (now - u.ts > 30000) return;
      // accuracy polygon (optional)
      const acc = Math.max(0, Number(u.acc||0));
      if (acc > 0){
        feats.push({
          type:'Feature',
          properties:{ uid, kind:'acc' },
          geometry:{ type:'Polygon', coordinates:[ circlePolygon([u.lng,u.lat], acc) ] }
        });
      }
      // dot + label
      feats.push({
        type:'Feature',
        properties:{ uid, kind:'point', name: u.name || '' },
        geometry:{ type:'Point', coordinates:[u.lng,u.lat] }
      });
    });
    src.setData({ type:'FeatureCollection', features:feats });
  }

  // ---------------- Auth flows ----------------
  let my = { uid:null, name:'', live:false, watchId:null, follow:true, lastLL:null };
  let presenceUnsub = null;

  function deriveName(user, fallbackDoc){
    if (user?.displayName) return user.displayName;
    if (fallbackDoc?.exists && fallbackDoc.data()?.name) return fallbackDoc.data().name;
    if (user?.email) return user.email.split('@')[0];      // fallback: email local-part
    return 'Me';
  }

  auth.onAuthStateChanged(async (user)=>{
    if (user){
      const profDoc = await db.collection('users').doc(user.uid).get();
      my.uid  = user.uid;
      my.name = deriveName(user, profDoc);
      // Ensure Firestore has the name for others to read
      await db.collection('users').doc(user.uid).set({ name: my.name }, { merge:true });

      authScreens.style.display = 'none';
      mapDiv.style.display = 'block';
      legend.style.display = 'block';
      authedCtrls.style.display = 'flex';
      statusEl.textContent = 'Signed in';
    } else {
      await stopLive();
      users.clear(); renderPeople();
      authedCtrls.style.display = 'none';
      mapDiv.style.display = 'none';
      legend.style.display = 'none';
      authScreens.style.display = 'flex';
      signupCard.style.display = 'none';
      loginCard.style.display = 'block';
    }
  });

  // Auth UI
  const loginBtn = document.getElementById('loginBtn');
  const loginEmail = document.getElementById('loginEmail');
  const loginPass = document.getElementById('loginPass');
  const loginErr  = document.getElementById('loginErr');
  loginBtn.onclick = async ()=>{
    loginErr.textContent = '';
    try { await auth.signInWithEmailAndPassword(loginEmail.value.trim(), loginPass.value); }
    catch(e){ loginErr.textContent = e.message; }
  };

  const signupBtn = document.getElementById('signupBtn');
  const suName = document.getElementById('suName');
  const suEmail = document.getElementById('suEmail');
  const suPass = document.getElementById('suPass');
  const signupErr= document.getElementById('signupErr');
  signupBtn.onclick = async ()=>{
    signupErr.textContent = '';
    const name = suName.value.trim();
    if (!name){ signupErr.textContent = 'Please enter display name.'; return; }
    try{
      const cred = await auth.createUserWithEmailAndPassword(suEmail.value.trim(), suPass.value);
      await cred.user.updateProfile({ displayName: name });
      await db.collection('users').doc(cred.user.uid).set({ name }, { merge:true });
    }catch(e){ signupErr.textContent = e.message; }
  };

  const logoutBtn = document.getElementById('logoutBtn');
  logoutBtn.onclick = async ()=>{ await stopLive(); await auth.signOut(); };

  // ---------------- Live location ----------------
  const goLiveBtn = document.getElementById('goLiveBtn');
  const stopLiveBtn= document.getElementById('stopLiveBtn');
  const followBtn  = document.getElementById('followBtn');
  const statusEl   = document.getElementById('status');

  goLiveBtn.onclick = ()=> startLive();
  stopLiveBtn.onclick = ()=> stopLive();
  followBtn.onclick = ()=>{
    my.follow = !my.follow;
    followBtn.textContent = `üéØ Follow: ${my.follow ? 'ON' : 'OFF'}`;
    if (my.follow && my.lastLL) map.easeTo({ center: my.lastLL, duration: 500 });
  };

  function startPresenceListener(){
    if (presenceUnsub) return;
    presenceUnsub = db.collection('presence').onSnapshot((snap)=>{
      const now = Date.now();
      snap.docChanges().forEach(ch=>{
        const uid = ch.doc.id; const d = ch.doc.data();
        if (!d || typeof d.lat!=='number' || typeof d.lng!=='number') return;
        const ts = d.updatedAt?.toMillis?.() ? d.updatedAt.toMillis() : now;
        // store/update user
        users.set(uid, {
          lng: d.lng, lat: d.lat,
          name: d.name || '', acc: d.acc || 0,
          ts
        });
        if (ch.type === 'removed') users.delete(uid);
      });
      renderPeople();
    });
  }
  function stopPresenceListener(){ if (presenceUnsub){ presenceUnsub(); presenceUnsub=null; } }

  function startLive(){
    if (!auth.currentUser){ return; }
    if (!SECURE_OK) toast('Use HTTPS or localhost for precise GPS.', true);
    if (my.watchId != null) return;

    startPresenceListener(); // only when live

    // First: try a "precision first fix" with a longer timeout
    navigator.geolocation.getCurrentPosition(
      (pos)=>{ onPos(pos, true); },
      (err)=>{ /* ignore; watch will still start */ },
      { enableHighAccuracy:true, timeout:20000, maximumAge:0 }
    );

    // Then: continuous updates
    my.watchId = navigator.geolocation.watchPosition(onPos, onErr, {
      enableHighAccuracy:true, maximumAge:0, timeout:15000
    });

    goLiveBtn.disabled = true; stopLiveBtn.disabled = false;
    statusEl.textContent = 'Live (sharing)‚Ä¶';
    my.live = true;
  }

  async function stopLive(){
    if (my.watchId != null){ navigator.geolocation.clearWatch(my.watchId); my.watchId = null; }
    if (my.uid){ try{ await db.collection('presence').doc(my.uid).delete(); }catch(e){} }
    stopPresenceListener();
    users.delete(my.uid); renderPeople();
    goLiveBtn.disabled = false; stopLiveBtn.disabled = true;
    statusEl.textContent = auth.currentUser ? 'Signed in' : 'Signed out';
    my.live = false;
  }

  // Clean up presence on tab close
  window.addEventListener('beforeunload', ()=>{ if (my.live && my.uid) db.collection('presence').doc(my.uid).delete(); });

  let writeTimer=null;
  function onPos(pos, isFirst=false){
    const { latitude, longitude, accuracy } = pos.coords;
    my.lastLL = [longitude, latitude];

    // ensure my display name is set
    const myDisplay = my.name && my.name.trim() ? my.name : (auth.currentUser?.email ? auth.currentUser.email.split('@')[0] : 'Me');

    // Update local store for me
    users.set(my.uid, { lng: longitude, lat: latitude, name: myDisplay, acc: accuracy||0, ts: Date.now() });
    renderPeople();

    if (my.follow || isFirst) map.easeTo({ center:[longitude, latitude], duration: isFirst ? 0 : 400 });

    statusEl.textContent = `Live ‚Ä¢ ¬±${Math.round(accuracy||0)} m`;

    // Throttle Firestore writes
    clearTimeout(writeTimer);
    writeTimer = setTimeout(()=> {
      db.collection('presence').doc(my.uid).set({
        lat: latitude, lng: longitude, acc: accuracy||0,
        name: myDisplay,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge:true });
    }, 300);
  }

  function onErr(err){
    statusEl.textContent = err.message || 'Location error';
    if (err.code === 1) toast('Allow location permissions.', true);
  }
</script>
</body>
</html>
